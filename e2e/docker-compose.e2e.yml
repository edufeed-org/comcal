services:
  typesense:
    image: typesense/typesense:28.0
    restart: on-failure
    ports:
      - '18108:8108' # Use 18108 externally to avoid conflicts with other Typesense instances
    volumes:
      - typesense-data:/data
    command: '--data-dir /data --api-key=e2e-test-key --enable-cors'
    healthcheck:
      test: ['CMD-SHELL', "bash -c 'echo > /dev/tcp/localhost/8108'"] # Internal port check
      interval: 2s
      timeout: 3s
      retries: 5

  amb-relay:
    image: git.edufeed.org/edufeed/amb-relay:main
    restart: on-failure
    ports:
      - '17001:3334'
    environment:
      - NAME=E2E AMB Relay
      - TS_HOST=http://typesense:8108
      - TS_APIKEY=e2e-test-key
      - TS_COLLECTION=e2e-amb
      - SEMANTIC_SEARCH_ENABLED=false
    depends_on:
      typesense:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '-q',
          '-O-',
          '--header=Accept: application/nostr+json',
          'http://localhost:3334'
        ]
      interval: 2s
      timeout: 3s
      retries: 10
      start_period: 5s

  calendar-relay:
    image: git.edufeed.org/edufeed/calendar-relay:main
    restart: on-failure
    ports:
      - '17002:3334'
    environment:
      - NAME=E2E Calendar Relay
      - PORT=3334
      - DB_PATH=/data/events.db
      - INDEX_PATH=/data/calendar_index.db
    volumes:
      - calendar-data:/data
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '-q',
          '-O-',
          '--header=Accept: application/nostr+json',
          'http://localhost:3334'
        ]
      interval: 2s
      timeout: 3s
      retries: 5

  strfry:
    image: dockurr/strfry:latest
    restart: on-failure
    ports:
      - '17003:7777'
    volumes:
      - strfry-data:/app/strfry-db
      - ./strfry.conf:/etc/strfry.conf:ro
    ulimits:
      nofile:
        soft: 1000000
        hard: 1000000
    healthcheck:
      test: ['CMD-SHELL', "bash -c 'echo > /dev/tcp/localhost/7777'"]
      interval: 2s
      timeout: 3s
      retries: 5

  blossom:
    image: ghcr.io/hzrd149/blossom-server:latest
    restart: on-failure
    ports:
      - '13000:3000'
    environment:
      - DATA_PATH=/data
    volumes:
      - blossom-data:/data
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:3000']
      interval: 2s
      timeout: 3s
      retries: 5

volumes:
  typesense-data:
  calendar-data:
  strfry-data:
  blossom-data:
